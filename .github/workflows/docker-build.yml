name: Build and Push Docker Image

# Triggered by:
#   - push to main  (when an auto-update or manual PR is merged)
#   - pull_request  (validation build only — no push to Docker Hub)
#   - workflow_dispatch (manual run)
#
# Daily version-checking lives in check-versions.yml.

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.event_name }}
  cancel-in-progress: true

env:
  DOCKER_IMAGE: sahuno/claude_gemini_container

# ─────────────────────────────────────────────────────────────────────────────
# Job 1: validate
#   Builds a local amd64 image, runs smoke tests, and runs Trivy.
#   Runs on every event (push, PR, manual). Never pushes to Docker Hub.
# ─────────────────────────────────────────────────────────────────────────────
jobs:
  validate:
    runs-on: ubuntu-latest

    permissions:
      security-events: write   # upload Trivy SARIF to Security tab

    outputs:
      claude:     ${{ steps.versions.outputs.claude }}
      gemini:     ${{ steps.versions.outputs.gemini }}
      codex:      ${{ steps.versions.outputs.codex }}
      snakemake:  ${{ steps.versions.outputs.snakemake }}
      nf_core:    ${{ steps.versions.outputs.nf_core }}
      build_date: ${{ steps.versions.outputs.build_date }}
      date_tag:   ${{ steps.versions.outputs.date_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Dockerfile ARG defaults are the single source of truth for versions.
      - name: Extract versions from Dockerfile
        id: versions
        run: |
          echo "claude=$(grep '^ARG CLAUDE_VERSION='       Dockerfile | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "gemini=$(grep '^ARG GEMINI_VERSION='       Dockerfile | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "codex=$(grep '^ARG CODEX_VERSION='         Dockerfile | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "snakemake=$(grep '^ARG SNAKEMAKE_VERSION=' Dockerfile | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "nf_core=$(grep '^ARG NF_CORE_VERSION='     Dockerfile | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"                         >> $GITHUB_OUTPUT
          echo "date_tag=$(date +'%Y%m%d')"                                           >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build amd64-only and load into the local Docker daemon for testing.
      # --cache-to seeds the GHA layer cache so the deploy job reuses layers.
      - name: Build test image (amd64, local load)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE }}:test
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            CLAUDE_VERSION=${{ steps.versions.outputs.claude }}
            GEMINI_VERSION=${{ steps.versions.outputs.gemini }}
            CODEX_VERSION=${{ steps.versions.outputs.codex }}
            SNAKEMAKE_VERSION=${{ steps.versions.outputs.snakemake }}
            NF_CORE_VERSION=${{ steps.versions.outputs.nf_core }}
            BUILD_DATE=${{ steps.versions.outputs.build_date }}

      # ── Smoke tests ──────────────────────────────────────────────────────
      - name: Smoke test
        run: |
          IMAGE="${{ env.DOCKER_IMAGE }}:test"
          echo "=== Smoke Testing Container ==="

          echo "--- Claude Code ---"
          docker run --rm "$IMAGE" claude --version

          echo "--- Gemini CLI ---"
          docker run --rm "$IMAGE" sh -c "gemini --version 2>&1 || gemini version 2>&1 || (echo 'gemini --version not available; checking binary' && which gemini)"

          echo "--- OpenAI Codex ---"
          docker run --rm "$IMAGE" sh -c "which codex && (codex --version 2>&1 | head -3 || echo 'codex binary present')"

          echo "--- Python stack ---"
          docker run --rm "$IMAGE" python3 -c "
          import numpy, pandas, matplotlib, seaborn, scipy, sklearn
          print('numpy', numpy.__version__)
          print('pandas', pandas.__version__)
          print('matplotlib', matplotlib.__version__)
          print('Python stack OK')
          "

          echo "--- Snakemake ---"
          docker run --rm "$IMAGE" snakemake --version

          echo "--- Nextflow ---"
          docker run --rm "$IMAGE" nextflow -version 2>&1 | head -3 || true

          echo "--- container-info ---"
          docker run --rm "$IMAGE" container-info

          echo "=== All smoke tests passed ==="

      # ── Security scan ─────────────────────────────────────────────────────
      # exit-code=0: findings are reported to the Security tab but do NOT
      # fail the build.  Adjust to '1' to enforce a hard gate.
      - name: Security scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:test
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          exit-code: '0'

      - name: Upload Trivy SARIF to Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true   # needs GitHub Advanced Security; graceful on private repos
        with:
          sarif_file: trivy-results.sarif
          category: trivy-container

# ─────────────────────────────────────────────────────────────────────────────
# Job 2: deploy
#   Builds multi-arch (amd64 + arm64) and pushes three tags to Docker Hub.
#   Creates a GitHub Release with pinned pull commands.
#   Only runs on push to main (never on PRs).
# ─────────────────────────────────────────────────────────────────────────────
  deploy:
    needs: validate
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    # DOCKER environment scopes the Docker Hub push secrets.
    environment:
      name: DOCKER

    permissions:
      contents: write   # create GitHub Releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Three tags:
      #   :latest           — always the most recent image
      #   :claude-X.Y.Z     — pinned to the Claude Code version
      #   :YYYYMMDD         — date-pinned for reproducible pulls
      # amd64 layers are already cached from the validate job.
      - name: Build and push multi-arch image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:claude-${{ needs.validate.outputs.claude }}
            ${{ env.DOCKER_IMAGE }}:${{ needs.validate.outputs.date_tag }}
          labels: |
            org.opencontainers.image.title=AI CLI + Bioinformatics Container
            org.opencontainers.image.description=Claude Code, Gemini CLI, OpenAI Codex, Snakemake, Nextflow
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ needs.validate.outputs.build_date }}
            claude.version=${{ needs.validate.outputs.claude }}
            gemini.version=${{ needs.validate.outputs.gemini }}
            codex.version=${{ needs.validate.outputs.codex }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          build-args: |
            CLAUDE_VERSION=${{ needs.validate.outputs.claude }}
            GEMINI_VERSION=${{ needs.validate.outputs.gemini }}
            CODEX_VERSION=${{ needs.validate.outputs.codex }}
            SNAKEMAKE_VERSION=${{ needs.validate.outputs.snakemake }}
            NF_CORE_VERSION=${{ needs.validate.outputs.nf_core }}
            BUILD_DATE=${{ needs.validate.outputs.build_date }}

      - name: Update Docker Hub description
        if: github.ref == 'refs/heads/main'
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: sahuno/claude_gemini_container
          readme-filepath: ./README.md

      # Create a GitHub Release for every build on main.
      # Provides a permanent browsable history with pinned pull commands.
      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        env:
          CLAUDE_VERSION:    ${{ needs.validate.outputs.claude }}
          GEMINI_VERSION:    ${{ needs.validate.outputs.gemini }}
          CODEX_VERSION:     ${{ needs.validate.outputs.codex }}
          SNAKEMAKE_VERSION: ${{ needs.validate.outputs.snakemake }}
          NF_CORE_VERSION:   ${{ needs.validate.outputs.nf_core }}
          DATE_TAG:          ${{ needs.validate.outputs.date_tag }}
          GH_TOKEN:          ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="claude-${CLAUDE_VERSION}-${DATE_TAG}"

          # Idempotent: skip if this exact release already exists
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "Release $TAG already exists — skipping."
            exit 0
          fi

          # Fill placeholders in the checked-in release notes template
          cp .github/release-notes-template.md /tmp/release-notes.md
          sed -i "s/CLAUDE_VER/${CLAUDE_VERSION}/g"         /tmp/release-notes.md
          sed -i "s/GEMINI_VER/${GEMINI_VERSION}/g"         /tmp/release-notes.md
          sed -i "s/CODEX_VER/${CODEX_VERSION}/g"           /tmp/release-notes.md
          sed -i "s/SNAKEMAKE_VER/${SNAKEMAKE_VERSION}/g"   /tmp/release-notes.md
          sed -i "s/NF_CORE_VER/${NF_CORE_VERSION}/g"       /tmp/release-notes.md
          sed -i "s/DATE_TAG_VAL/${DATE_TAG}/g"             /tmp/release-notes.md

          gh release create "$TAG" \
            --title "Container Release: Claude ${CLAUDE_VERSION} (${DATE_TAG})" \
            --notes-file /tmp/release-notes.md \
            --latest
